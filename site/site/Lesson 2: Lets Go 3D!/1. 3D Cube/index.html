
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../Lesson%201%3A%20Hello%20Metal/3.%20Textures/">
      
      
        <link rel="next" href="../2.%20Basic%20Lighting/">
      
      <link rel="icon" href="../../images/metal-logo-dall-e.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.9">
    
    
      
        <title>3D Cube - Metal Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.85bb2934.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a6bdf11c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CSF+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"SF Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-9B3546Q8FY"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-9B3546Q8FY",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-9B3546Q8FY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#going-3d-with-metal" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Metal Tutorial" class="md-header__button md-logo" aria-label="Metal Tutorial" data-md-component="logo">
      
  <img src="../../images/metal-logo-dall-e.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Metal Tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3D Cube
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wmarti/MetalTutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    MetalTutorial
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Metal Tutorial" class="md-nav__button md-logo" aria-label="Metal Tutorial" data-md-component="logo">
      
  <img src="../../images/metal-logo-dall-e.png" alt="logo">

    </a>
    Metal Tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wmarti/MetalTutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    MetalTutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome to Metal
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Setup/" class="md-nav__link">
        Lesson 0: Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Lesson 1: Hello Metal
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Lesson 1: Hello Metal
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lesson%201%3A%20Hello%20Metal/1.%20Hello%20Window/" class="md-nav__link">
        1. Hello Window
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lesson%201%3A%20Hello%20Metal/2.%20Hello%20Triangle/" class="md-nav__link">
        2. Hello Triangle
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lesson%201%3A%20Hello%20Metal/3.%20Textures/" class="md-nav__link">
        3. Textures
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Lesson 2: Lets Go 3D!
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Lesson 2: Lets Go 3D!
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          1. 3D Cube
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        1. 3D Cube
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-a-cube" class="md-nav__link">
    Creating a Cube
  </a>
  
    <nav class="md-nav" aria-label="Creating a Cube">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clockwise-and-counter-clockwise-winding-orders" class="md-nav__link">
    Clockwise and Counter-Clockwise Winding Orders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-a-coordinate-system" class="md-nav__link">
    Choosing a Coordinate System
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformations" class="md-nav__link">
    Transformations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-perspective-projection" class="md-nav__link">
    What is Perspective Projection?
  </a>
  
    <nav class="md-nav" aria-label="What is Perspective Projection?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#various-types-of-projection-visualized" class="md-nav__link">
    Various Types of Projection Visualized
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#isometric-projection-visualised" class="md-nav__link">
    Isometric Projection Visualised
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perspective-projection-visualised" class="md-nav__link">
    Perspective Projection Visualised
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mathematics-behind-perspective-projection" class="md-nav__link">
    Mathematics Behind Perspective Projection
  </a>
  
    <nav class="md-nav" aria-label="Mathematics Behind Perspective Projection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-are-they-useful" class="md-nav__link">
    Why are they useful?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting It All Together
  </a>
  
    <nav class="md-nav" aria-label="Putting It All Together">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-defining-the-square-in-model-space" class="md-nav__link">
    Step 1: Defining the Square in Model Space
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-model-transformation-translation" class="md-nav__link">
    Step 2: Model Transformation (Translation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-view-transformation" class="md-nav__link">
    Step 3: View Transformation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-perspective-transformation" class="md-nav__link">
    Step 4: Perspective Transformation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-transform-to-ndc" class="md-nav__link">
    Step 5: Transform to NDC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-the-viewport-transform" class="md-nav__link">
    Step 6: The Viewport Transform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-7-rasterization" class="md-nav__link">
    Step 7: Rasterization
  </a>
  
    <nav class="md-nav" aria-label="Step 7: Rasterization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#result" class="md-nav__link">
    Result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuing-with-the-code" class="md-nav__link">
    Continuing with the Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-a-depth-buffer" class="md-nav__link">
    Setting up a Depth Buffer
  </a>
  
    <nav class="md-nav" aria-label="Setting up a Depth Buffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multisample-anti-aliasing" class="md-nav__link">
    Multisample Anti-Aliasing
  </a>
  
    <nav class="md-nav" aria-label="Multisample Anti-Aliasing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#msaa-texture" class="md-nav__link">
    MSAA Texture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#depth-texture" class="md-nav__link">
    Depth Texture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discarding-unecessary-faces-and-fragments" class="md-nav__link">
    Discarding Unecessary Faces and Fragments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2.%20Basic%20Lighting/" class="md-nav__link">
        2. Basic Lighting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3.%20Loading%203D%20Models/" class="md-nav__link">
        3. Loading 3D Models
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Advanced Chapters
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Advanced Chapters
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Extra%20Chapters/Compute%20Shaders/" class="md-nav__link">
        Compute Shaders
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-a-cube" class="md-nav__link">
    Creating a Cube
  </a>
  
    <nav class="md-nav" aria-label="Creating a Cube">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clockwise-and-counter-clockwise-winding-orders" class="md-nav__link">
    Clockwise and Counter-Clockwise Winding Orders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-a-coordinate-system" class="md-nav__link">
    Choosing a Coordinate System
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformations" class="md-nav__link">
    Transformations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-perspective-projection" class="md-nav__link">
    What is Perspective Projection?
  </a>
  
    <nav class="md-nav" aria-label="What is Perspective Projection?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#various-types-of-projection-visualized" class="md-nav__link">
    Various Types of Projection Visualized
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#isometric-projection-visualised" class="md-nav__link">
    Isometric Projection Visualised
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perspective-projection-visualised" class="md-nav__link">
    Perspective Projection Visualised
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mathematics-behind-perspective-projection" class="md-nav__link">
    Mathematics Behind Perspective Projection
  </a>
  
    <nav class="md-nav" aria-label="Mathematics Behind Perspective Projection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-are-they-useful" class="md-nav__link">
    Why are they useful?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting It All Together
  </a>
  
    <nav class="md-nav" aria-label="Putting It All Together">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-defining-the-square-in-model-space" class="md-nav__link">
    Step 1: Defining the Square in Model Space
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-model-transformation-translation" class="md-nav__link">
    Step 2: Model Transformation (Translation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-view-transformation" class="md-nav__link">
    Step 3: View Transformation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-perspective-transformation" class="md-nav__link">
    Step 4: Perspective Transformation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-transform-to-ndc" class="md-nav__link">
    Step 5: Transform to NDC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-the-viewport-transform" class="md-nav__link">
    Step 6: The Viewport Transform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-7-rasterization" class="md-nav__link">
    Step 7: Rasterization
  </a>
  
    <nav class="md-nav" aria-label="Step 7: Rasterization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#result" class="md-nav__link">
    Result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuing-with-the-code" class="md-nav__link">
    Continuing with the Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-a-depth-buffer" class="md-nav__link">
    Setting up a Depth Buffer
  </a>
  
    <nav class="md-nav" aria-label="Setting up a Depth Buffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multisample-anti-aliasing" class="md-nav__link">
    Multisample Anti-Aliasing
  </a>
  
    <nav class="md-nav" aria-label="Multisample Anti-Aliasing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#msaa-texture" class="md-nav__link">
    MSAA Texture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#depth-texture" class="md-nav__link">
    Depth Texture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discarding-unecessary-faces-and-fragments" class="md-nav__link">
    Discarding Unecessary Faces and Fragments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="going-3d-with-metal">Going 3D with Metal</h1>
<p>Things will get a lot more interesting in this Chapter, as we're finally going 3D!</p>
<p>To do this, we'll need to add 3 important things to our rendering engine:</p>
<ol>
<li>A 3D Object to Render. For this chapter, we'll render a cube.</li>
<li>Perspective Projection to add a sense of depth to our scene.</li>
<li>A Depth Buffer for discarding non-visible fragments.</li>
</ol>
<p>How will we create a cube? What is perspective projection? What is a... Depth Buffer? We'll discuss these topics in the following sections, as well as a few extra topics that will be useful for us as our scenes and objects get more complicated. Before diving in, if you are at all rusty with linear algebra concepts, and in particular matrices and basis vectors, I would highly recommend watching <a href="https://www.youtube.com/watch?v=kjBOesZCoqc&amp;list=PL0-GT3co4r2y2YErbmuJw2L5tW4Ew2O5B">3blue1brown's Linear Algebra series</a>.</p>
<h2 id="creating-a-cube">Creating a Cube</h2>
<p>A cube happens to be a perfect progression from the square that we rendered in the previous chapter. It's a simple object, so we can define the vertices manually.</p>
<p>First, let's update the MTLEngine header file:
<div class="highlight"><span class="filename">mtl_engine.hpp</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MTLEngine</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">private</span><span class="o">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="hll"><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">Buffer</span><span class="o">*</span><span class="w"> </span><span class="n">cubeVertexBuffer</span><span class="p">;</span>
</span><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="hll"><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">Buffer</span><span class="o">*</span><span class="w"> </span><span class="n">transformationBuffer</span><span class="p">;</span>
</span><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">}</span>
</code></pre></div>
First, let's open our <code>VertexData.hpp</code> file and add a struct called<code>TransformationData</code> that will hold our model, view, and perspective matrices. If you're not sure what those are, I'll get into it later in the chapter:
<div class="highlight"><span class="filename">VertexData.hpp</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="cp">#pragma once</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;simd/simd.h&gt;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">simd</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">VertexData</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="n">float4</span><span class="w"> </span><span class="n">position</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="n">float2</span><span class="w"> </span><span class="n">textureCoordinate</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="p">};</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="k">struct</span><span class="w"> </span><span class="nc">TransformationData</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="n">float4x4</span><span class="w"> </span><span class="n">modelMatrix</span><span class="p">;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="n">float4x4</span><span class="w"> </span><span class="n">viewMatrix</span><span class="p">;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="n">float4x4</span><span class="w"> </span><span class="n">perspectiveMatrix</span><span class="p">;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="p">};</span>
</code></pre></div></p>
<p>For now, we'll define all 36 of our cube vertices manually. Just like in the last chapter, each face has 6 vertices, because our square is defined with two triangles. Each triangle of course has 3 vertices each. So, 3 vertices per triangle, 2 per face, 6 faces in total. That's 36 vertices of fun :), Lucky for you, I've defined vertices and texture coordinates for you:
<div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::createCube</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="c1">// Cube for use in a right-handed coordinate system with triangle faces</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">// specified with a Counter-Clockwise winding order.</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">VertexData</span><span class="w"> </span><span class="n">cubeVertices</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">        </span><span class="c1">// Front face</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">        </span><span class="c1">// Back face</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">        </span><span class="c1">// Top face</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">        </span><span class="c1">// Bottom face</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="w">        </span><span class="c1">// Left face</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">        </span><span class="p">{{</span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="w">        </span><span class="c1">// Right face</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}},</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="w">        </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">}},</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="w">    </span><span class="n">cubeVertexBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">newBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cubeVertices</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cubeVertices</span><span class="p">),</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">ResourceStorageModeShared</span><span class="p">);</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="w">    </span><span class="n">transformationBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">newBuffer</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TransformationData</span><span class="p">),</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">ResourceStorageModeShared</span><span class="p">);</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a><span class="w">    </span><span class="c1">// Make sure to change working directory to Metal-Tutorial root</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="w">    </span><span class="c1">// directory via Product -&gt; Scheme -&gt; Edit Scheme -&gt; Run -&gt; Options</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="w">    </span><span class="n">grassTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Texture</span><span class="p">(</span><span class="s">&quot;assets/mc_grass.jpeg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">metalDevice</span><span class="p">);</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="p">}</span>
</code></pre></div>
For now, we're also going to create our transformationBuffer here, we'll clean that up later. Note the order in which I've specified the vertices here. More experienced folks might recognize that the vertices have been specified to have a Counter Clockwise (CCW) Winding Order.Essentially, winding order is the order in which we specify the vertices of a triangle. I've included a visual below to get a better idea of what that looks like:</p>
<h3 id="clockwise-and-counter-clockwise-winding-orders">Clockwise and Counter-Clockwise Winding Orders</h3>
<p><img alt="winding-order" src="/images/winding-order-example.png" /></p>
<p>A triangle has 2 sides. In our case, we will instruct Metal to use the Counter Clockwise triangle winding order. The vertex winding order will determine which "face" or side of a given triangle corresponds to the front. Metal can then use this information to determine if a triangle face is facing towards or away from us, and cull (not render) it correspondingly. If a triangle is facing toward us we want to render it, as it will be unobstructed. If it's facing away from us, we can't see it, so we don't want to render it. Try to visualise the cube that we're going to be rendering. At any given time, we can only see <em>at most</em> 3 sides of it. That means that the remaining non-visible sides can be culled by Metal. Vertex winding order is important, as it gives us a cheap way to determine which triangles we don't need to render.</p>
<p>Another question to ask is, how do you know which winding order to choose? This depends on the <strong><em>coordinate system</em></strong> that you want to use for your rendering engine.</p>
<h3 id="choosing-a-coordinate-system">Choosing a Coordinate System</h3>
<p>An important decision that we need to make when building a 3D rendering application is to choose a coordinate system to work with. What I mean by a coordinate system is, within the space where our objects and camera exists, what direction do we want our x, y, and z axis to point? The typical Cartesian coordinate system that you might be familiar with, we like to think of in the world of computer graphics as a left-handed coordinate system. In a left-handed coordinate system, the x-axis points to the right, the y-axis points up, and the z-axis points into your screen. If you hold your hand out in front of you and make an L shape with your thumb and index finger, these correspond to your x and y axis respectively. If you then point your middle finger out away from you, in the direction of your screen, this would correspond to the z-axis. If you do the same hand signal with your right hand, and then turn your hand around so that your middle finger points towards you, this should give you a visual representation of a right-handed coordinate system, where the positive z-axis (your middle finger) points towards us, out of the screen. Out of personal preference, I have decided to follow this coordinate convention throughout this tutorial series. Additionally, Ive provided a visual below of the two coordinate systems Ive described.</p>
<table>
<thead>
<tr>
<th>Left-handed Coordinate System</th>
<th>Right-Handed Coordinate System</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="lhc-system" src="/images/left_handed_coordinate_system.png" /></td>
<td><img alt="rhc-system" src="/images/right_handed_coordinate_system.png" /></td>
</tr>
</tbody>
</table>
<p>There are some important ramifications that we should be aware of when choosing to work with a right or left-handed coordinate system. </p>
<ul>
<li>Direction of the result of the cross-product of two vectors. When using a right-handed coordinate system, we follow something called the <a href="https://en.wikipedia.org/wiki/Right-hand_rule">right-hand rule</a>. As an example, image that we have two vectors of length one (aka, unit vectors) that lie on the x-axis and y-axis pictured in the right-handed coordinate system above: <span class="arithmatex">\({V}_1 = (1, 0, 0)\)</span>, <span class="arithmatex">\({V}_2 = (0, 1, 0)\)</span>. To get another unit vector that points in the direction of the z-axis, we want to do <span class="arithmatex">\({V}_1 \times {V}_2\)</span>. Notice the order I've specified the cross product in here, try making a sweeping motion with your fingers from vector <span class="arithmatex">\({V}_1\)</span> in the direction of vector <span class="arithmatex">\({V}_2\)</span>, it should match the counter-clockwise rotation displayed for the z-axis. This is the same thing that Metal will do behind the scenes to determine the front and back face triangles of your 3D models when we instruct it to use a Counter Clockwise winding order for our vertices.<ul>
<li>The winding order, or order in which you specify your vertices can impact how the object is rendered. In a right-handed coordinate system, we typically use a counter-clockwise winding order for our vertices, which allows us to easily determine whether a face is front-facing, facing towards us, or back-facing facing away from us, allowing Metal to easily discard and not render faces pointing away from us.</li>
<li>The normal vector for a face is calculated using the cross product of two edge vectors from the polygon. Normals are essential for various rendering techniques such as lighting calculations.</li>
</ul>
</li>
<li>Looking Direction: In a right-handed system, the camera typically looks down the negative z-axis by default, whereas in a left-handed system the camera typically looks down the positive z-axis.</li>
<li>Transformation matrices will slightly differ, like the perspective projection matrix. Or, if you choose to rotate an object around a particular axis, the direction of rotation will be flipped in a right versus left handed system, as you can see in the diagram above.</li>
</ul>
<h3 id="transformations">Transformations</h3>
<p>Now that we have decided what kind of coordinate system we want to use, we need to discuss the series of transformations that our objects will go through to be rendered on the screen. Typically when you import a model into your rendering engine, the coordinates that are provided will center the object at the origin. Take our cube for example, we defined it to be centered at the origin. We call this initial coordinate space for each model, the aptly named model-space. If we imagine a scene in a game, its usually going to have all sorts of objects scattered throughout the scene, perhaps looking something like in the image below:</p>
<p><img alt="halo3.jpg" src="/images/halo_3.png" /></p>
<p>This mean's that we need some way to be able to move our objects around in space. Luckily, we can use affine transformations in the form of four dimensional matrices to do this. Using these, we can easily scale, translate, rotate, and sheer our vertices in space. I'll get a little bit more into the specifics in the Mathematics section of this chapter. When we scale, manipulate, or otherwise move our objects from their initial position/orientation in "model-space" to our desired position within the world, we say that these objects are now in "world-space". Thats great, weve now oriented everything properly in our scene, but, how do we view it from our cameras perspective, like in the image above? Well, your camera, much like the objects in your scene will also have a position and an orientation within the world or world-space. In order to view everything from our cameras perspective, were going to apply another matrix transformation called the view or sometimes the camera transformation. The key thing to realize here is that, we arent actually moving around any of the objects in the scene with the view transformation. We are simply applying a change of basis transformation to our world-space coordinates, along with a translation to <em>move</em> the origin of our world to the cameras current position. This new view-space coordinate system is defined by three vectors that we define our camera to have, as well as the position of the camera in world-space:</p>
<ol>
<li><strong>Forward Vector (F)</strong>: Points in the direction the camera is looking.</li>
<li><strong>Right Vector (R)</strong>: Points to the right of the camera.</li>
<li><strong>Up Vector (U)</strong>: Points above the camera.</li>
<li><strong>Camera Position (P)</strong>: The Position of the camera in World-Space.</li>
</ol>
<p>A common form for the view matrix <span class="arithmatex">\( M_{view} \)</span> used in a right-handed coordinate system is as follows:</p>
<div class="arithmatex">\[
M_{view} = \begin{pmatrix}
R_x &amp; R_y &amp; R_z &amp; -R \cdot P \\
U_x &amp; U_y &amp; U_z &amp; -U \cdot P \\
-F_x &amp; -F_y &amp; -F_z &amp; F \cdot P \\
0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
\]</div>
<p>The resulting view-space matrix will combine a change of basis matrix defined by our Forward, Right, and Up vectors, with a translation matrix that moves the origin of the world to the cameras position. Now that our vertices are in view-space, the coordinate-space defined by our camera's position and orientation, we are ready to apply the perspective projection matrix. The perspective projection matrix is defined by the coordinate-system that we originally chose to work with, being a right-handed coordinate system, as well as the field of view (fov) of our camera, the aspect-ratio of our window, as well as a near and far clipping plane. In essence, each vertex on each model in our scene will go through this series of transformations to end up as a position in clip-space:</p>
<div class="arithmatex">\[{P}_{clip}= {M}_{perspective} * {M}_{view} * {M}_{world} * {V}_{model} \]</div>
<p>Once our vertex positions have been transformed to clip-space, our job is done, and Metal will clip or cull objects outside of the viewing frustum, and clip objects to the viewing frustum. It will then automatically perform the perspective or "homogenous" divide on each of our coordinates, transforming it to the final coordinate space called Normalized Device Coordinates. Well, what does all of that mean? We're going to get to that in the next section.</p>
<h2 id="what-is-perspective-projection">What is Perspective Projection?</h2>
<p>With our coordinate system chosen and our Cube now defined, we have to discuss the topic of Perspective Projection. In the context of 3D Computer Graphics, perspective projection is a technique used to represent a three-dimensional object on a two-dimensional plane, being our computer screen, mimicking the way our eyes perceive depth and scale. Essentially, we'll want to map 3D points in the world to 2D points on a rendering surface called the viewing or projection plane (which ends up being displayed on your computer screen), while maintaining the perception of depth". Objects that are farther away from the camera appear smaller on the viewing plane, and parallel lines converge to a single point in the distance, known as the vanishing point.</p>
<p>Getting objects to appear on our screen and mimic the way they appear in real life is a pretty involved process. There are a lot of different steps to it, and if you arent familiar with the concept of perspective projection within the context of a 3D graphics pipeline, dont worry about it too much. It may take a little while to wrap your head around the entire process, so you can always feel free to just follow along with the code and try to understand it as you go along.</p>
<h3 id="various-types-of-projection-visualized">Various Types of Projection Visualized</h3>
<p><img alt="perspective0" src="/images/perspective0.png" />
In reality, there are a variety of ways to map or "project" 3D points onto a 2D surface, and they have different purposes. In our case, we're trying to simulate how we would perceive things in real life using perspective projection. The further an object is away from us, the smaller we want it to appear on our screen, and vice versa as it gets closer to us. If we were an architect however, we might choose instead to use an orthographic projection to visualize our architectural drawings. Orthographic projections map our 3D points straight onto the viewing plane without any regard for the distance away, and so they are widely used in various fields such as engineering, architecture, design, and art for their ability to represent 3D objects accurately and without distortion. They are especially useful in situations where it's essential to maintain the exact dimensions and shapes of the objects being depicted.</p>
<h3 id="isometric-projection-visualised">Isometric Projection Visualised</h3>
<p><img alt="isometric" src="/images/isometric.png" /></p>
<h3 id="perspective-projection-visualised">Perspective Projection Visualised</h3>
<p><img alt="perspective" src="/images/perspective2.png" /></p>
<h3 id="mathematics-behind-perspective-projection">Mathematics Behind Perspective Projection</h3>
<p>Perspective projection can be represented mathematically by a 4D transformation matrix. Well use this perspective projection matrix to transform a point from what are called homogenous coordinates to its 2D screen position. In the context of 3D graphics, a vertex position in 3D space that would typically be represented with Cartesian coordinates (x, y, z) can be represented in 4D homogenous coordinates as (x, y, z, w). </p>
<h4 id="why-are-they-useful">Why are they useful?</h4>
<ul>
<li>Unified Representation: Homogeneous coordinates allow for a unified representation of translation, rotation, scaling, and other affine transformations as matrix multiplications. Without our 4D homogeneous coordinates, translation of our 3D objects would not be possible through matrix multiplication alone.</li>
<li>Perspective Projection: They are crucial for perspective transformations. The division by w (known as the homogeneous divide or the perspective divide) allows for points to be moved closer or farther away from the camera, effectively simulating perspective.</li>
</ul>
<p><img alt="perspective_frustum" src="/images/perspective_viewing_frustum.png" /></p>
<p>The perspective projection matrix takes in a variety of parameters, such as the field of view of your camera, the aspect ratio of the window/screen that you are rendering too, as well as the nearZ and farZ clipping planes.  Based on these parameters, the perspective projection matrix creates what is called a viewing frustum, essentially a rectangular pyramid around your scene that represents what you can see, originating from the cameras location. When you apply this perspective projection transformation matrix to your vertices, it essentially warps this pyramid-like viewing frustum into a cube shape that we call clip-space. When you apply the perspective projection matrix, the range of your x, y and z coordinates will be between [-w, w]. The w-component of your homogenous coordinate is manipulated in such a way that Metal will then divide our x, y, and z coordinates by the w-component automatically to normalize the range of our x, y, and z coordinates to Normalized Device Coordinate (NDC) space. In Metal, NDC is a left-handed coordinate system that ranges from [-1,1] in the x and y direction, and from [0,1] in the z direction. Having this normalized box-like shape allows us to easily test whether vertices in our scene are in or outside of the box, and discard or cull them appropriately, as we dont want to render anything we cant see. If you have half of an object inside the NDC box and half outside, then it will clip the object to the edge of the box, creating new vertices for the object along the box's edge.</p>
<p><img alt="metal_ndc" src="/images/metal_ndc.png" /></p>
<p>In our engine, we'll use a right-hand perpsective projection matrix that will take in the field of view specified as an angle in radians (e.g. 90 * PI/2), the aspect ratio of our window (width/height), as well as the distance of the near and far clipping planes from the camera:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">matrix_float4x4</span><span class="w"> </span><span class="nf">matrix_perspective_right_hand</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">fovyRadians</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">                                              </span><span class="kt">float</span><span class="w"> </span><span class="n">aspect</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">                                              </span><span class="kt">float</span><span class="w"> </span><span class="n">nearZ</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">                                              </span><span class="kt">float</span><span class="w"> </span><span class="n">farZ</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">{</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">ys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tanf</span><span class="p">(</span><span class="n">fovyRadians</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ys</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">aspect</span><span class="p">;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">zs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">farZ</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">nearZ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">farZ</span><span class="p">);</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">matrix_make_rows</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w">          </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">                             </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ys</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w">          </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">                             </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">zs</span><span class="p">,</span><span class="w"> </span><span class="n">nearZ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">zs</span><span class="p">,</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">                             </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w">          </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="p">}</span>
</code></pre></div></p>
<div class="arithmatex">\[
M_{perspective} = \begin{pmatrix}
xs &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; ys &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; zs &amp; nearZ \times zs \\
0 &amp; 0 &amp; -1 &amp; 0
\end{pmatrix}
\]</div>
<h2 id="putting-it-all-together">Putting It All Together</h2>
<p>I think its best to explain the series of transformations that our vertices will go through in order to be projected onto the screen with an example. Let's imagine we have a square that we want to render. Imagine it is positioned initially at the origin, aligned with the <span class="arithmatex">\(xz\)</span> plane. The 4 homogenous vertices defining the square are:</p>
<h3 id="step-1-defining-the-square-in-model-space">Step 1: Defining the Square in Model Space</h3>
<ul>
<li><span class="arithmatex">\( A_{model} = [ -1, 0, -1, 1 ] \)</span></li>
<li><span class="arithmatex">\( B_{model} = [  1, 0, -1, 1 ] \)</span></li>
<li><span class="arithmatex">\( C_{model} = [  1, 0,  1, 1 ] \)</span></li>
<li><span class="arithmatex">\( D_{model} = [ -1, 0,  1, 1 ] \)</span></li>
</ul>
<h3 id="step-2-model-transformation-translation">Step 2: Model Transformation (Translation)</h3>
<p>We'll move the square down the negative <span class="arithmatex">\(z\)</span>-axis by two units. This requires a translation operation, represented by a translation matrix:</p>
<div class="arithmatex">\[
M_{translation} = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; -2 \\
0 &amp; 0 &amp; 0 &amp; 0
\end{pmatrix}
\]</div>
<p>Multiplying each point by this matrix, we get these translated points in world-space:</p>
<ul>
<li><span class="arithmatex">\( A_{world} = [ -1, 0, -3, 1] = M_{translation} \times A_{model} \)</span></li>
<li><span class="arithmatex">\( B_{world} = [  1, 0, -3, 1] = M_{translation} \times B_{model} \)</span></li>
<li><span class="arithmatex">\( C_{world} = [  1, 0, -1, 1] = M_{translation} \times C_{model} \)</span></li>
<li><span class="arithmatex">\( D_{world} = [ -1, 0, -1, 1] = M_{translation} \times D_{model} \)</span></li>
</ul>
<h3 id="step-3-view-transformation">Step 3: View Transformation</h3>
<p>To construct a view matrix, you'll need three orthogonal unit vectors. A unit vector is a vector that has a magnitude of 1. In other words, it is a vector that points in a certain direction but has been normalized to have a length of 1.</p>
<ol>
<li><strong>Forward Vector (F)</strong>: Points in the direction the camera is looking.</li>
<li><strong>Right Vector (R)</strong>: Points to the right of the camera.</li>
<li><strong>Up Vector (U)</strong>: Points above the camera.</li>
</ol>
<p>You'll also need the camera's position vector <span class="arithmatex">\( P \)</span>.</p>
<ol>
<li><strong>Camera Position (P)</strong>: The Position of the camera in World-Space.</li>
</ol>
<p>A common form for the view matrix <span class="arithmatex">\( M_{view} \)</span> used in a right-handed coordinate system is as follows:</p>
<div class="arithmatex">\[
M_{view} = \begin{pmatrix}
R_x &amp; R_y &amp; R_z &amp; -R \cdot P \\
U_x &amp; U_y &amp; U_z &amp; -U \cdot P \\
-F_x &amp; -F_y &amp; -F_z &amp; F \cdot P \\
0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
\]</div>
<p>We'll define our Forward, Right, and Up vectors, as well as the camera position like so:</p>
<ul>
<li><span class="arithmatex">\(F = (1, 0, 0) \)</span></li>
<li><span class="arithmatex">\(R = (0, 1, 0) \)</span></li>
<li><span class="arithmatex">\(U = (0, 0,-1) \)</span></li>
<li><span class="arithmatex">\(P = (0, 1, 1) \)</span></li>
</ul>
<p>This will give us the resulting view vector:</p>
<div class="arithmatex">\[
M_{view} = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp;-1 \\
0 &amp; 0 &amp; 1 &amp;-1 \\
0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
\]</div>
<p>When we apply this view transformation matrix to our square vertices we get:</p>
<ul>
<li><span class="arithmatex">\( A_{view} = [ -1, -1, -4, 1] = M_{view} \times A_{world} \)</span></li>
<li><span class="arithmatex">\( B_{view} = [  1, -1, -4, 1] = M_{view} \times B_{world} \)</span></li>
<li><span class="arithmatex">\( C_{view} = [  1, -1, -2, 1] = M_{view} \times C_{world} \)</span></li>
<li><span class="arithmatex">\( D_{view} = [ -1, -1, -2, 1] = M_{view} \times D_{world} \)</span></li>
</ul>
<p>Remember, these are the coordinates of the square in the coordinate space oriented in the direction of the camera, where the camera's position is the new origin. The camera was positioned at <span class="arithmatex">\(P = (0, 1, 1)\)</span> on the <span class="arithmatex">\(z\)</span>-axis, so when we move the original origin to the camera's position, it's as though everything has been shifted in the opposite direction. Essentially, we move the square by one unit in the direction of the negative z-axis and negative y-axis.</p>
<h3 id="step-4-perspective-transformation">Step 4: Perspective Transformation</h3>
<p>Let's use a simplified perspective projection matrix for this example. We'll ignore aspect ratio and the far plane, focusing only on the near plane, which is at <span class="arithmatex">\(z = -1\)</span>. However, to make perspective account for Metal's NDC, we need to modify the z-coordinates in the perspective transformation. Given the original perspective matrix:</p>
<div class="arithmatex">\[
M_{perspective} = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; -1 \\
0 &amp; 0 &amp; -1 &amp; 0
\end{pmatrix}
\]</div>
<p>Our resulting perspective projection matrix becomes:</p>
<div class="arithmatex">\[
M_{Metal} = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; -0.5 &amp; -0.5 \\
0 &amp; 0 &amp; -1 &amp; 0
\end{pmatrix}
\]</div>
<p>The third row third column's -0.5 scales the z-coordinate to half its value, and the -0.5 at the end of the third row translates the z-coordinate so it's in the range [0, 1] after the perspective divide.</p>
<p>Multiplying each point by this matrix, we get:</p>
<ul>
<li><span class="arithmatex">\( A_{clip} = [ -1, -1,  1.5, 4 ] = M_{Metal} \times A_{view} \)</span></li>
<li><span class="arithmatex">\( B_{clip} = [  1, -1,  1.5, 4 ] = M_{Metal} \times B_{view} \)</span></li>
<li><span class="arithmatex">\( C_{clip} = [  1, -1,  0.5, 2 ] = M_{Metal} \times C_{view} \)</span></li>
<li><span class="arithmatex">\( D_{clip} = [ -1, -1,  0.5, 2 ] = M_{Metal} \times D_{view} \)</span></li>
</ul>
<h3 id="step-5-transform-to-ndc">Step 5: Transform to NDC</h3>
<p>To transform our vertices to NDC, Metal will automatically divide their respective x, y and z components by their w component, leaving us with:</p>
<ul>
<li><span class="arithmatex">\( A_{NDC} = ( -0.25, -0.25,  0.375) \)</span></li>
<li><span class="arithmatex">\( B_{NDC} = (  0.25, -0.25,  0.375) \)</span></li>
<li><span class="arithmatex">\( C_{NDC} = (  0.5, -0.5,  0.25) \)</span></li>
<li><span class="arithmatex">\( D_{NDC} = ( -0.5, -0.5,  0.25) \)</span></li>
</ul>
<p>After the perspective divide, the points are in normalized device coordinates. In this example, you can see that the <span class="arithmatex">\( x \)</span> coordinates of points A and B are now closer to the origin (scaled down to <span class="arithmatex">\( \pm 0.25 \)</span>) compared to points C and D (<span class="arithmatex">\( \pm 0.5 \)</span>). This is because points A and B are positioned farther away in world-space from the camera (at <span class="arithmatex">\( z = -3 \)</span>, and so take on a larger w-component) compared to points C and D (at <span class="arithmatex">\( z = -1 \)</span>). Notice how the division by the w component is what caused this "squishing" that perspective provides.</p>
<h3 id="step-6-the-viewport-transform">Step 6: The Viewport Transform</h3>
<p>In Metal, the rasterizer stage is responsible for transforming our Normalized-device coordinates (NDC) into <em>viewport coordinates</em>, which correspond to pixels on our screen. The (x,y) coordinates in the viewport are measured in pixels, with the origin placed in the top-left corner of the viewport. Metal will take our NDC coordinates x and y values and scale them by the width and height of the screen respectively, to end up between (0, screen width) in the x-direction, and (0, screen height) in the y-direction:</p>
<div class="arithmatex">\[ x_{screen} = \frac{width}{2} \times x_{NDC} + 1 \]</div>
<div class="arithmatex">\[ y_{screen} = \frac{height}{2} \times y_{NDC} + 1 \]</div>
<p>Below is a visual representation of the viewport coordinate system used in Metal, borrowed from the Metal Shading Language Specification:
<img alt="viewport_coord" src="/images/viewport-coord.png" /></p>
<h3 id="step-7-rasterization">Step 7: Rasterization</h3>
<p>After our square goes through this series of transformations to end up in NDC coordinates, the rasterizer stage transforms our vertices into screen space. The rasterizer then takes these vertices and determines which pixels on the screen they cover. This process is called rasterization. The result is a set of fragments. Each fragment corresponds to a potential pixel on the screen and carries with it interpolated data from the vertices, such as color, texture coordinates, and depth.</p>
<h4 id="result">Result</h4>
<p>When we put it all together, our scene might look a little something like this:</p>
<p><img alt="putting-together" src="/images/putting_it_all_together.png" /></p>
<p>Hopefully this walkthrough has helped demonstrate the effects of each of the steps that our vertices go through, including perspective projection and the the significance of the homogenous coordinates mathematically. </p>
<h2 id="continuing-with-the-code">Continuing with the Code</h2>
<p>For convenience, we're going to add two new files provided by Apple to our project: <a href="/files/AAPLMathUtilities.cpp">AAPLMathUtilities.cpp</a> and <a href="/files/AAPLMathUtilities.h">AAPLMathUtilities.h</a>. We'll include the header in <code>mtl_engine.hpp</code>:
<div class="highlight"><span class="filename">mtl_engine.hpp</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AAPLMathUtilities.h&quot;</span>
</code></pre></div>
This provides us a variety of utility functions for common operations utilised in Computer Graphics such as matrix transformations, quaternion rotations, and creating perspective projection matrices. </p>
<p>Since we've already defined our Cube and created our <code>cubeVertexBuffer</code> as well as our <code>transformationBuffer</code>, we can now define our model, view, and perspective projection matrices:</p>
<div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::encodeRenderCommand</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderCommandEncoder</span><span class="o">*</span><span class="w"> </span><span class="n">renderCommandEncoder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="c1">// Moves the Cube 2 units down the negative Z-axis</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">translationMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix4x4_translation</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mf">-1.0</span><span class="p">);</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">angleInDegrees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glfwGetTime</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">45</span><span class="p">;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">angleInRadians</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angleInDegrees</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.0f</span><span class="p">;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">rotationMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix4x4_rotation</span><span class="p">(</span><span class="n">angleInRadians</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">modelMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd_mul</span><span class="p">(</span><span class="n">translationMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">rotationMatrix</span><span class="p">);</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">// Unit-Right</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">// Unit-Up</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">-1</span><span class="p">};</span><span class="w"> </span><span class="c1">// Unit-Forward</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span><span class="w"> </span><span class="c1">// Camera Position in World Space</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">viewMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_make_rows</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="p">),</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">                                                  </span><span class="n">U</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="p">),</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">                                                 </span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="p">),</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">                                                  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">aspectRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">metalLayer</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.0f</span><span class="p">);</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">nearZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">farZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">perspectiveMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_perspective_right_hand</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span><span class="w"> </span><span class="n">aspectRatio</span><span class="p">,</span><span class="w"> </span><span class="n">nearZ</span><span class="p">,</span><span class="w"> </span><span class="n">farZ</span><span class="p">);</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">    </span><span class="n">TransformationData</span><span class="w"> </span><span class="n">transformationData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">modelMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">viewMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">perspectiveMatrix</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">transformationBuffer</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">transformationData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">transformationData</span><span class="p">));</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setRenderPipelineState</span><span class="p">(</span><span class="n">metalRenderPSO</span><span class="p">);</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setVertexBuffer</span><span class="p">(</span><span class="n">cubeVertexBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setVertexBuffer</span><span class="p">(</span><span class="n">transformationBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">PrimitiveType</span><span class="w"> </span><span class="n">typeTriangle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">PrimitiveTypeTriangle</span><span class="p">;</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">    </span><span class="n">NS</span><span class="o">::</span><span class="n">UInteger</span><span class="w"> </span><span class="n">vertexStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="w">    </span><span class="n">NS</span><span class="o">::</span><span class="n">UInteger</span><span class="w"> </span><span class="n">vertexCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">36</span><span class="p">;</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setFragmentTexture</span><span class="p">(</span><span class="n">grassTexture</span><span class="o">-&gt;</span><span class="n">texture</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">drawPrimitives</span><span class="p">(</span><span class="n">typeTriangle</span><span class="p">,</span><span class="w"> </span><span class="n">vertexStart</span><span class="p">,</span><span class="w"> </span><span class="n">vertexCount</span><span class="p">);</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="p">}</span>
</code></pre></div>
<p>Using the <code>AAPLMatchUtilities.h</code> library we just included, we first define a 4x4 translation matrix so we can move the cube 1 unit down the negative <span class="arithmatex">\(z\)</span>-axis, as our camera will looking down the negative z-axis. To make our scene a little bit more interesting, we will also make the cube rotate over time. We first define an angle in degrees that changes over time by using <code>glfwGetTime()</code>, and then convert it to radians because our rotation matrix helper function expects radian angles as an input.</p>
<p>The next step is to create our Model Matrix. When multiplying affine transformations together, we need to be careful about the order in which we specify them, as matrix multiplication is not associative. If you're unsure as to why, try thinking about what would happen to our vertsice if we first uncentered our object from the origin, and <em>then</em> rotated it.  You can also try playing with the code yourself, creating various transformations and playing with their order. Again, if you are rusty on your matrices, or are unfamiliar with linear algebra in general, I highly recommend watching <a href="https://www.youtube.com/watch?v=kjBOesZCoqc&amp;list=PL0-GT3co4r2y2YErbmuJw2L5tW4Ew2O5B">3blue1brown's Linear Algebra series</a>. In this case, we want to first rotate our cube, and <em>then</em> translate it. Unfortunately, <code>simd_mul()</code> doesn't really provide a way to tell what order we're multiplying in, but what we want in mathematical notation is:</p>
<div class="arithmatex">\[ M_{model} = M_{translation} * M_{rotation} \]</div>
<p>We've now successfully defined our <code>modelMatrix</code>, which moves our objects in the scene to our desired position and orientation in world-space. We're now going to define our <code>viewMatrix</code>, which will effectively act as a change of basis matrix to put our vertices into a new coordinate space defined by the camera's right, up, and forward vectors, as well as it's position in  world-space.</p>
<p>We'll first define our unit vectors required for the "camera, our Right, Up, Forward vectors. We'll also define the Camera position in world-space. We'll then create our <code>viewMatrix</code> using the <code>matrix_make_rows()</code> utility function from our <code>AAPLMatchUtilities.h</code> header.</p>
<p><div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::encodeRenderCommand</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderCommandEncoder</span><span class="o">*</span><span class="w"> </span><span class="n">renderCommandEncoder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">// Unit-Right</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">// Unit-Up</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">-1</span><span class="p">};</span><span class="w"> </span><span class="c1">// Unit-Forward</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd</span><span class="o">::</span><span class="n">float3</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span><span class="w"> </span><span class="c1">// Camera Position in World Space</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">viewMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_make_rows</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="p">),</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">                                                  </span><span class="n">U</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="p">),</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">                                                 </span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="p">),</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">                                                  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="p">}</span>
</code></pre></div>
We'll then create our perspective projection matrix, getting the aspect-ratio from our metalLayer width and height, we'll set the fov at 90 degrees and convert it to radians, and set the nearZ clipping plane at 0.1 units away from the camera, and the farZ clipping plane at 100 units away. Also be sure to update the vertexCount to 36:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="p">...</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kt">float</span><span class="w"> </span><span class="n">aspectRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">metalLayer</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kt">float</span><span class="w"> </span><span class="n">fov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.0f</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kt">float</span><span class="w"> </span><span class="n">nearZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kt">float</span><span class="w"> </span><span class="n">farZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">perspectiveMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_perspective_right_hand</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">                                                                  </span><span class="n">aspectRatio</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">                                                                  </span><span class="n">nearZ</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">                                                                  </span><span class="n">farZ</span><span class="p">);</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="n">TransformationData</span><span class="w"> </span><span class="n">transformationData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">modelMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">viewMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">perspectiveMatrix</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="n">memcpy</span><span class="p">(</span><span class="n">transformationBuffer</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">transformationData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">transformationData</span><span class="p">));</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="p">...</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="n">NS</span><span class="o">::</span><span class="n">UInteger</span><span class="w"> </span><span class="n">vertexCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">36</span><span class="p">;</span>
</code></pre></div>
<p>Finally, we'll rename our <code>square.metal</code> file to <code>cube.metal</code>, as we're now rendering a cube, and update the code to apply our transformation matrices to each vertex of the cube:
<div class="highlight"><span class="filename">cube.metal</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">vertex</span><span class="w"> </span><span class="n">VertexOut</span><span class="w"> </span><span class="n">vertexShader</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">vertexID</span><span class="w"> </span><span class="p">[[</span><span class="n">vertex_id</span><span class="p">]],</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">             </span><span class="n">constant</span><span class="w"> </span><span class="n">VertexData</span><span class="o">*</span><span class="w"> </span><span class="n">vertexData</span><span class="p">,</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="hll"><span class="w">             </span><span class="n">constant</span><span class="w"> </span><span class="n">TransformationData</span><span class="o">*</span><span class="w"> </span><span class="n">transformationData</span><span class="p">)</span>
</span><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">{</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="n">VertexOut</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="hll"><span class="w">    </span><span class="n">out</span><span class="p">.</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transformationData</span><span class="o">-&gt;</span><span class="n">perspectiveMatrix</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">transformationData</span><span class="o">-&gt;</span><span class="n">viewMatrix</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">transformationData</span><span class="o">-&gt;</span><span class="n">modelMatrix</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vertexData</span><span class="p">[</span><span class="n">vertexID</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
</span><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="n">out</span><span class="p">.</span><span class="n">textureCoordinate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vertexData</span><span class="p">[</span><span class="n">vertexID</span><span class="p">].</span><span class="n">textureCoordinate</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="p">}</span>
</code></pre></div></p>
<p>With this we can launch our application an- OH NO! What's this??</p>
<p><img alt="no-zbuffer" src="/images/no-zBuffer.png" /></p>
<p>That doesn't look quite right does it? I've put a different texture on the cube to make the effect very obvious. <em>One</em> of the issues is that we don't have what's called a "depth buffer". The other issue is that all the faces of our cube are being rendered, because we haven't told Metal what winding order we're using or whether to cull the corresponding front or back faces. The winding order issue is an easy fix, but let's start to fix this mess by integrating a depth buffer into our renderer.</p>
<h2 id="setting-up-a-depth-buffer">Setting up a Depth Buffer</h2>
<p>A depth buffer, also known as a z-buffer, is an essential component in the land of computer graphics, particularly when rendering 3D scenes. Its primary purpose is to resolve visibility, i.e., to determine which objects (or parts of objects) are visible from a particular viewpoint and which are obscured by other objects. You should be able to understand this based on how our cube is rendering. The issue is, Metal is drawing the back face over the front face, which doesn't make any sense, but because we aren't using a depth buffer it doesn't know how to use the depth information to draw it correctly.</p>
<p>After Metal applies the viewport transformation to our objects in Normalized-Device Coordinate space, the coordinates of the objects are in screen space, which means they have specific pixel locations on the screen and depth values relative to the camera. When the rendering process begins, the depth buffer is created, essentially just as a texture that is same resolution as the rendering target (in our case, the screen), and each value in the depth buffer is typically set to a maximum, like 1.0 which corresponds to maximum z-depth in our Normalized-Device Coordinate space. In the standard rendering pipeline, after rasterization, fragments are processed in the fragment shader and <em>then</em> undergo depth testing. </p>
<p>After an individual fragment is processed by the fragment shader, the fragment undergoes depth testing, where the fragment's depth value is compared against the current value in the depth buffer for that fragments screen position. If the depth test passes, meaning the current fragment's z-value is <em>lower</em> than the current one, the depth buffer is updated with the fragment's depth value, and the fragment's color is then potentially written to the color buffer (after additional stages like blending). If however, the depth test fails, meaning that the depth value of the current fragment being processed is <em>greater</em> than the one in the depth buffer, the fragment is discarded, and its color isn't written into the color buffer.</p>
<p>You might think it strange or inefficient that the fragment shader might do all of that processing for an individual fragment, only to then perform the depth test and discard the fragment all together. In certain cases, you would certainly be right. This is why modern GPUs implement an optimization called <em>early-z</em> or <em>early depth testing</em>, where the GPU might actually check the depth of fragments before they're processed by the fragment shader. But, this can't be used in situations where the fragment shader modifies the depth value, or to give a more concrete example, when you're working with transparent objects like a glass window. While opaque objects can simply overwrite the color of a pixel if they're closer to the camera, transparent objects need to blend their color with whatever is already in the color buffer. As a result, transparent fragments can't simply discard fragments behind them, making Early-Z less effective.</p>
<p>You can see in the image below what a depth buffer actually looks like compared to the final rendered image on the screen. The bottom image represents the depth buffer, where depth is based on what we call a "resolve" value or "R" value. An R value of 1.0 corresponds to an infinite distance, or the white background. The closer the objects gets to the camera, the darker the images becomes and the smaller the R value. If you look at the two points I've select on the 3D Model below for example, the point further away has a larger R value of 0.9789, compared to the point that's closer to the camera of 0.8589.</p>
<p><img alt="depthBuffer" src="/images/depth_buffer.png" /></p>
<h3 id="multisample-anti-aliasing">Multisample Anti-Aliasing</h3>
<p>While we add our Depth Buffer, we're also going to implement Multisampled Anti-Aliasing (MSAA), which follows a very similar process to integrating our Depth Buffer into our renderer. MSAA is a technique used in computer graphics to improve image quality by reducing visual artifacts known as "aliasing". Aliasing occurs when the high-frequency details in an image can't be adequately represented at the resolution at which the image is sampled. This typically manifests as jagged edges or "jaggies" on objects in the image, especially along diagonal or curved lines. MSAA tries to solve this issue by sampling multiple color values within a single pixel and blending them together.</p>
<p>One benefit of MSAA is that it operates only on the <em>edges</em> of the geometry in our scene, making it more efficient than other techniques such as Super-Sampled Anti Aliasing (SSAA), which typically renders the entire scene at a 2-4x higher resolution and then downsamples the result. Additionally, MSAA invokes the fragment shader only <em>once</em> for each pixel, and shares the result among the samples. For testing whether a sample point is covered, the triangle depth is interpolated at each sample point that is covered and compared with the value in the depth buffer. The depth test is performed for each subsample, so its size must be adjusted based on the number of samples we'll be using per pixel. In our case, we're going to use 4 samples per pixel, so the depth buffer will be 4x the size as if we did not use MSAA at all.</p>
<p>Take a look at the diagram below, on the left we have a triangle that overlaps part of a pixel on the screen. Without multi-sampling, the black dot in the center is used as the sampling point the rasterizer will use to pick the color that gets passed onto the fragment shader for that pixel. In this case, the triangle doesn't overlap with it so the final color is white. If you look at the example on the right however, we now have 4 sample points (hence, multisampling), two that lay in the triangle and two that lay outside of it. The rasterizer chooses one sample to pass on to the fragment shader to apply further processing. The final pixel color becomes a weighted blend of the colors of the 4 sampling points. In this case, since two samples lie inside the triangle, both of those samples will be assigned the color of the output of the pixel shader, and will be blended evenly with the color of the two samples laying outside of the triangle, giving us this final pinkish color.</p>
<p><img alt="msaa-example" src="/images/msaa-example.png" /></p>
<blockquote>
<p>This image is borrowed from <a href="https://www.realtimerendering.com/">Real Time Rendering, 3rd Edition</a>.</p>
</blockquote>
<p>Below is a comparison of the edges of our cube, without MSAA, and with 4x MSAA enabled. You should notice that the image on the right has smoother edges than on the left.</p>
<table>
<thead>
<tr>
<th>MSAA Disabled</th>
<th>4x MSAA</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="no-msaa" src="/images/no-msaa.png" /></td>
<td><img alt="4x-msaa" src="/images/msaa.png" /></td>
</tr>
</tbody>
</table>
<p>We're going to need to update our <code>MTLEngine</code> class by adding a view functions and member variables. In particular, we'll have a function <code>createBuffers</code> for allocating our transformation buffer on the GPU, and we'll need to create texture objects for our Depth Buffer and MSAA textures. We'll also abstract out our render pass descriptor creation to its own function, and have a function to recreate our Depth and MSAA textures when our window resizes. We're also going to create a variety of objects for holding our depth stencil state and depth/msaa textures, and abstracting out our renderpass descriptor:</p>
<div class="highlight"><span class="filename">mtl_engine.hpp</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MTLEngine</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">private</span><span class="o">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">createCube</span><span class="p">();</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">createBuffers</span><span class="p">();</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">createDepthAndMSAATextures</span><span class="p">();</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">createRenderPassDescriptor</span><span class="p">();</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="c1">// Upon resizing, update Depth and MSAA Textures.</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateRenderPassDescriptor</span><span class="p">();</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">DepthStencilState</span><span class="o">*</span><span class="w"> </span><span class="n">depthStencilState</span><span class="p">;</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderPassDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">renderPassDescriptor</span><span class="p">;</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">Texture</span><span class="o">*</span><span class="w"> </span><span class="n">msaaRenderTargetTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">Texture</span><span class="o">*</span><span class="w"> </span><span class="n">depthTexture</span><span class="p">;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sampleCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="p">}</span>
</code></pre></div>
<p>We're adding quite a few things here. The first functions we'll update are our <code>init()</code> and <code>cleanup()</code> functions:</p>
<p><div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="n">initDevice</span><span class="p">();</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">initWindow</span><span class="p">();</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">createCube</span><span class="p">();</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="hll"><span class="w">    </span><span class="n">createBuffers</span><span class="p">();</span>
</span><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="n">createDefaultLibrary</span><span class="p">();</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="n">createCommandQueue</span><span class="p">();</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="n">createRenderPipeline</span><span class="p">();</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="hll"><span class="w">    </span><span class="n">createDepthAndMSAATextures</span><span class="p">();</span>
</span><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="hll"><span class="w">    </span><span class="n">createRenderPassDescriptor</span><span class="p">();</span>
</span><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="p">}</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="p">...</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="kt">void</span><span class="w"> </span><span class="n">MTLEngine</span><span class="o">::</span><span class="n">cleanup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="n">glfwTerminate</span><span class="p">();</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="hll"><span class="w">    </span><span class="n">transformationBuffer</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="hll"><span class="w">    </span><span class="n">msaaRenderTargetTexture</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="hll"><span class="w">    </span><span class="n">depthTexture</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="hll"><span class="w">    </span><span class="n">renderPassDescriptor</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">grassTexture</span><span class="p">;</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="p">}</span>
</code></pre></div>
The function calls should be self explanatory here.</p>
<p>We'll first use our newly added <code>createBuffers()</code> function to create our transformation buffer. Make sure to remove the code we had in <code>createCube()</code> that created the transformation buffer earlier, and put it here:
<div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::createBuffers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="n">transformationBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">newBuffer</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TransformationData</span><span class="p">),</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">ResourceStorageModeShared</span><span class="p">);</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="p">}</span>
</code></pre></div></p>
<p>Before we create our MSAA and Depth Buffer Textures, we need to update our render pipeline creation:</p>
<p><div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::createRenderPipeline</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">Function</span><span class="o">*</span><span class="w"> </span><span class="n">vertexShader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDefaultLibrary</span><span class="o">-&gt;</span><span class="n">newFunction</span><span class="p">(</span><span class="n">NS</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;vertexShader&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NS</span><span class="o">::</span><span class="n">ASCIIStringEncoding</span><span class="p">));</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">vertexShader</span><span class="p">);</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">Function</span><span class="o">*</span><span class="w"> </span><span class="n">fragmentShader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDefaultLibrary</span><span class="o">-&gt;</span><span class="n">newFunction</span><span class="p">(</span><span class="n">NS</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;fragmentShader&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NS</span><span class="o">::</span><span class="n">ASCIIStringEncoding</span><span class="p">));</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">fragmentShader</span><span class="p">);</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderPipelineDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">renderPipelineDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderPipelineDescriptor</span><span class="o">::</span><span class="n">alloc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="n">renderPipelineDescriptor</span><span class="o">-&gt;</span><span class="n">setVertexFunction</span><span class="p">(</span><span class="n">vertexShader</span><span class="p">);</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="n">renderPipelineDescriptor</span><span class="o">-&gt;</span><span class="n">setFragmentFunction</span><span class="p">(</span><span class="n">fragmentShader</span><span class="p">);</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">renderPipelineDescriptor</span><span class="p">);</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">PixelFormat</span><span class="w"> </span><span class="n">pixelFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">PixelFormat</span><span class="p">)</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">pixelFormat</span><span class="p">;</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="n">renderPipelineDescriptor</span><span class="o">-&gt;</span><span class="n">colorAttachments</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setPixelFormat</span><span class="p">(</span><span class="n">pixelFormat</span><span class="p">);</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="hll"><span class="w">    </span><span class="n">renderPipelineDescriptor</span><span class="o">-&gt;</span><span class="n">setSampleCount</span><span class="p">(</span><span class="n">sampleCount</span><span class="p">);</span>
</span><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="hll"><span class="w">    </span><span class="n">renderPipelineDescriptor</span><span class="o">-&gt;</span><span class="n">setDepthAttachmentPixelFormat</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">PixelFormatDepth32Float</span><span class="p">);</span>
</span><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="hll"><span class="w">    </span><span class="n">NS</span><span class="o">::</span><span class="n">Error</span><span class="o">*</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
</span><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="hll"><span class="w">    </span><span class="n">metalRenderPSO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">newRenderPipelineState</span><span class="p">(</span><span class="n">renderPipelineDescriptor</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</span><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metalRenderPSO</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="hll"><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Error creating render pipeline state: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="hll"><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="hll"><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">DepthStencilDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">depthStencilDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">DepthStencilDescriptor</span><span class="o">::</span><span class="n">alloc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
</span><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="hll"><span class="w">    </span><span class="n">depthStencilDescriptor</span><span class="o">-&gt;</span><span class="n">setDepthCompareFunction</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">CompareFunctionLessEqual</span><span class="p">);</span>
</span><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="hll"><span class="w">    </span><span class="n">depthStencilDescriptor</span><span class="o">-&gt;</span><span class="n">setDepthWriteEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="hll"><span class="w">    </span><span class="n">depthStencilState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">newDepthStencilState</span><span class="p">(</span><span class="n">depthStencilDescriptor</span><span class="p">);</span>
</span><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">    </span><span class="n">renderPipelineDescriptor</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="hll"><span class="w">    </span><span class="n">vertexShader</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="hll"><span class="w">    </span><span class="n">fragmentShader</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="p">}</span>
</code></pre></div>
We first set the sample count that our render pipeline will use, as this parameter must be consistent across all pipeline stages and resources that are involved in multi-sampling. This includes MSAA render targets, depth buffers, and the render pipeline itself. The Depth Attachment needs to be compatible with the depth texture that we will create. In addition, we want to make sure to use high precision values in our depth buffer, so we'll set it to <code>MTL::PixelFormatDepth32Float</code>. We'll also add in some error handline for our PSO, , and create a depth stencil descriptor. We'll set our depth compare function to <code>MTL::CompareFunctionLessEqual</code>, so the depth test will pass if the current depth is closer or the same. We're also going to allow the gpu to write to the depth buffer, with <code>setDepthWriteEnabled(true)</code>, since we're rendering only opaque objects here.</p>
<p>Next, we'll handle the creation of our MSAA and Depth Buffer Textures:</p>
<div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::createDepthAndMSAATextures</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">msaaTextureDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureDescriptor</span><span class="o">::</span><span class="n">alloc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="n">msaaTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setTextureType</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureType2DMultisample</span><span class="p">);</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="n">msaaTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setPixelFormat</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">PixelFormatBGRA8Unorm</span><span class="p">);</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="n">msaaTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setWidth</span><span class="p">(</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">drawableSize</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="n">msaaTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setHeight</span><span class="p">(</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">drawableSize</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="n">msaaTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setSampleCount</span><span class="p">(</span><span class="n">sampleCount</span><span class="p">);</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="n">msaaTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setUsage</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureUsageRenderTarget</span><span class="p">);</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="n">msaaRenderTargetTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">newTexture</span><span class="p">(</span><span class="n">msaaTextureDescriptor</span><span class="p">);</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">depthTextureDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureDescriptor</span><span class="o">::</span><span class="n">alloc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="n">depthTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setTextureType</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureType2DMultisample</span><span class="p">);</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="n">depthTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setPixelFormat</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">PixelFormatDepth32Float</span><span class="p">);</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">    </span><span class="n">depthTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setWidth</span><span class="p">(</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">drawableSize</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="n">depthTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setHeight</span><span class="p">(</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">drawableSize</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="n">depthTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setUsage</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">TextureUsageRenderTarget</span><span class="p">);</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">    </span><span class="n">depthTextureDescriptor</span><span class="o">-&gt;</span><span class="n">setSampleCount</span><span class="p">(</span><span class="n">sampleCount</span><span class="p">);</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="n">depthTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalDevice</span><span class="o">-&gt;</span><span class="n">newTexture</span><span class="p">(</span><span class="n">depthTextureDescriptor</span><span class="p">);</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="n">msaaTextureDescriptor</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">    </span><span class="n">depthTextureDescriptor</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="p">}</span>
</code></pre></div>
<p>We first create our descriptors, and set various parameters such for each:</p>
<h4 id="msaa-texture">MSAA Texture</h4>
<ol>
<li><strong>Texture Type (TextureType2DMultisample)</strong>: Specifies that this texture is a 2D texture with multiple samples per pixel, which is crucial for enabling MSAA.</li>
<li><strong>Pixel Format (PixelFormatBGRA8Unorm)</strong>: Determines the format of the color data in the texture. BGRA8Unorm means it uses 8 bits for each of the blue, green, red, and alpha channels, and the data is normalized.</li>
<li><strong>Width and Height</strong>: These set the dimensions of the texture, usually matching the dimensions of the output framebuffer or drawable area.</li>
<li><strong>Sample Count</strong>: This is the number of samples per pixel and is a key setting for MSAA. More samples typically result in better anti-aliasing but at the cost of performance and memory usage. Here, we're using 4 samples.</li>
<li><strong>Usage (TextureUsageRenderTarget)</strong>: Specifies how the texture will be used. Setting it as a render target means it can be written into by the GPU during rendering.</li>
</ol>
<h4 id="depth-texture">Depth Texture</h4>
<ol>
<li><strong>Texture Type (TextureType2DMultisample)</strong>: Same as with the MSAA texture, specifies a 2D texture with multiple samples, which is necessary if you're using MSAA.</li>
<li><strong>Pixel Format (PixelFormatDepth32Float)</strong>: Specifies that this texture will store depth information in a 32-bit floating-point format.</li>
<li><strong>Width and Height</strong>: Again, these usually match the dimensions of your framebuffer or drawable area.</li>
<li><strong>Usage (TextureUsageRenderTarget)</strong>: Indicates that this texture will be used as a target for rendering operations, specifically for storing depth information.</li>
<li><strong>Sample Count</strong>: Must match the sample count of the MSAA texture for correct depth testing.</li>
</ol>
<p>We'll also update our <code>resizeFrameBuffer()</code> and <code>initWindow()</code> functions:</p>
<p><div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::resizeFrameBuffer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="n">metalLayer</span><span class="p">.</span><span class="n">drawableSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CGSizeMake</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="hll"><span class="w">    </span><span class="c1">// Deallocate the textures if they have been created</span>
</span><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msaaRenderTargetTexture</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="hll"><span class="w">        </span><span class="n">msaaRenderTargetTexture</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="hll"><span class="w">        </span><span class="n">msaaRenderTargetTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
</span><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">depthTexture</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="hll"><span class="w">        </span><span class="n">depthTexture</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="hll"><span class="w">        </span><span class="n">depthTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
</span><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="hll"><span class="w">    </span><span class="n">createDepthAndMSAATextures</span><span class="p">();</span>
</span><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="hll"><span class="w">    </span><span class="n">metalDrawable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__bridge</span><span class="w"> </span><span class="n">CA</span><span class="o">::</span><span class="n">MetalDrawable</span><span class="o">*</span><span class="p">)[</span><span class="n">metalLayer</span><span class="w"> </span><span class="n">nextDrawable</span><span class="p">];</span>
</span><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="hll"><span class="w">    </span><span class="n">updateRenderPassDescriptor</span><span class="p">();</span>
</span><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">}</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::initWindow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="hll"><span class="w">    </span><span class="n">metalDrawable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__bridge</span><span class="w"> </span><span class="n">CA</span><span class="o">::</span><span class="n">MetalDrawable</span><span class="o">*</span><span class="p">)[</span><span class="n">metalLayer</span><span class="w"> </span><span class="n">nextDrawable</span><span class="p">];</span>
</span><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="p">}</span>
</code></pre></div>
We'll need to recreate our MSAA and Depth textures when we resize our window. We'll also need to recreate the drawable, and update our render pass descriptor with our freshly created textures!</p>
<p>Additionally, note that at the end of our <code>initWindow()</code> function, we will actually need to first create a <code>metalDrawable</code> so that when we can properly create our MSAA/Drawable Textures for the first frame of our application.</p>
<p>Next, we'll implement our <code>createRenderPassDescriptor()</code> and <code>updateRenderPassDescriptor()</code> functions:</p>
<p><div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::createRenderPassDescriptor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="n">renderPassDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderPassDescriptor</span><span class="o">::</span><span class="n">alloc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderPassColorAttachmentDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">colorAttachment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">renderPassDescriptor</span><span class="o">-&gt;</span><span class="n">colorAttachments</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderPassDepthAttachmentDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">depthAttachment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">renderPassDescriptor</span><span class="o">-&gt;</span><span class="n">depthAttachment</span><span class="p">();</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="n">colorAttachment</span><span class="o">-&gt;</span><span class="n">setTexture</span><span class="p">(</span><span class="n">msaaRenderTargetTexture</span><span class="p">);</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="n">colorAttachment</span><span class="o">-&gt;</span><span class="n">setResolveTexture</span><span class="p">(</span><span class="n">metalDrawable</span><span class="o">-&gt;</span><span class="n">texture</span><span class="p">());</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="n">colorAttachment</span><span class="o">-&gt;</span><span class="n">setLoadAction</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">LoadActionClear</span><span class="p">);</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="n">colorAttachment</span><span class="o">-&gt;</span><span class="n">setClearColor</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">ClearColor</span><span class="p">(</span><span class="mf">41.0f</span><span class="o">/</span><span class="mf">255.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">42.0f</span><span class="o">/</span><span class="mf">255.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">48.0f</span><span class="o">/</span><span class="mf">255.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">));</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="n">colorAttachment</span><span class="o">-&gt;</span><span class="n">setStoreAction</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">StoreActionMultisampleResolve</span><span class="p">);</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">    </span><span class="n">depthAttachment</span><span class="o">-&gt;</span><span class="n">setTexture</span><span class="p">(</span><span class="n">depthTexture</span><span class="p">);</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">    </span><span class="n">depthAttachment</span><span class="o">-&gt;</span><span class="n">setLoadAction</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">LoadActionClear</span><span class="p">);</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="n">depthAttachment</span><span class="o">-&gt;</span><span class="n">setStoreAction</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">StoreActionDontCare</span><span class="p">);</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="n">depthAttachment</span><span class="o">-&gt;</span><span class="n">setClearDepth</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="p">}</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::updateRenderPassDescriptor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">    </span><span class="n">renderPassDescriptor</span><span class="o">-&gt;</span><span class="n">colorAttachments</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setTexture</span><span class="p">(</span><span class="n">msaaRenderTargetTexture</span><span class="p">);</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">    </span><span class="n">renderPassDescriptor</span><span class="o">-&gt;</span><span class="n">colorAttachments</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setResolveTexture</span><span class="p">(</span><span class="n">metalDrawable</span><span class="o">-&gt;</span><span class="n">texture</span><span class="p">());</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="n">renderPassDescriptor</span><span class="o">-&gt;</span><span class="n">depthAttachment</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setTexture</span><span class="p">(</span><span class="n">depthTexture</span><span class="p">);</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="p">}</span>
</code></pre></div>
Here, we are abstracting our <code>renderPassDescriptor</code> creation out into it's own function, and creating it only once, whereas before we had its creation as part of our <code>sendRenderCommand()</code> function that was called every frame. </p>
<p>We'll create a color attachment which will serve as our <code>msaaRenderTargetTexture</code>, as well as a depth attachment for our <code>depthTexture</code>. We'll also create a function to update our <code>renderPassDescriptor</code> object every frame, by setting the  <code>msaaRenderTargetTexture</code> and <code>depthTexture</code>, and we'll also set our resolve texture, our <code>metalDrawable-&gt;texture()</code>, which is the texture we want our MSAA sampling data to <em>resolve</em> to. In our case, the MSAA texture will have 4 samples per pixel, and it will blend these together into one pixel so that it can be stored in the <code>metalDrawable</code> texture, as the drawable is what's finally presented to the screen. Technically, we don't need to keep setting our MSAA and depth textures each frame, but I'm keeping it here anyways as the operation is basically free, and in the event that we resize our window, we can easily call this function to reset and resize these textures.</p>
<p>Next, we can update <code>sendRenderCommand()</code>:</p>
<div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::sendRenderCommand</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="n">metalCommandBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalCommandQueue</span><span class="o">-&gt;</span><span class="n">commandBuffer</span><span class="p">();</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="hll"><span class="w">    </span><span class="n">updateRenderPassDescriptor</span><span class="p">();</span>
</span><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderCommandEncoder</span><span class="o">*</span><span class="w"> </span><span class="n">renderCommandEncoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metalCommandBuffer</span><span class="o">-&gt;</span><span class="n">renderCommandEncoder</span><span class="p">(</span><span class="n">renderPassDescriptor</span><span class="p">);</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="n">encodeRenderCommand</span><span class="p">(</span><span class="n">renderCommandEncoder</span><span class="p">);</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">endEncoding</span><span class="p">();</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="n">metalCommandBuffer</span><span class="o">-&gt;</span><span class="n">presentDrawable</span><span class="p">(</span><span class="n">metalDrawable</span><span class="p">);</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="n">metalCommandBuffer</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">();</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="n">metalCommandBuffer</span><span class="o">-&gt;</span><span class="n">waitUntilCompleted</span><span class="p">();</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="p">}</span>
</code></pre></div>
<p>Here, we're simply having <code>MTLEngine::sendRenderCommand()</code> update our <code>renderPassDescriptor</code> object with the <code>updateRenderPassDescriptor()</code> function we just created , rather than recreating it every frame like we did previously.</p>
<p><div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::encodeRenderCommand</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderCommandEncoder</span><span class="o">*</span><span class="w"> </span><span class="n">renderCommandEncoder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">translationMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix4x4_translation</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">angleInDegrees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glfwGetTime</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">90</span><span class="p">;</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">angleInRadians</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angleInDegrees</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.0f</span><span class="p">;</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">rotationMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix4x4_rotation</span><span class="p">(</span><span class="n">angleInRadians</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">modelMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_identity_float4x4</span><span class="p">;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="n">modelMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simd_mul</span><span class="p">(</span><span class="n">translationMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">rotationMatrix</span><span class="p">);</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">viewMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix4x4_translation</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">aspectRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">metalLayer</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">metalLayer</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180.0f</span><span class="p">);</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">nearZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">farZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">;</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">    </span><span class="n">matrix_float4x4</span><span class="w"> </span><span class="n">perspectiveMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_perspective_left_hand</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span><span class="w"> </span><span class="n">aspectRatio</span><span class="p">,</span><span class="w"> </span><span class="n">nearZ</span><span class="p">,</span><span class="w"> </span><span class="n">farZ</span><span class="p">);</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">    </span><span class="n">TransformationData</span><span class="w"> </span><span class="n">transformationData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">modelMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">viewMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">perspectiveMatrix</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">transformationBuffer</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">transformationData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">transformationData</span><span class="p">));</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="c1">//    renderCommandEncoder-&gt;setTriangleFillMode(MTL::TriangleFillModeLines);</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setRenderPipelineState</span><span class="p">(</span><span class="n">metalRenderPSO</span><span class="p">);</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="hll"><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setDepthStencilState</span><span class="p">(</span><span class="n">depthStencilState</span><span class="p">);</span>
</span><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setVertexBuffer</span><span class="p">(</span><span class="n">cubeVertexBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setVertexBuffer</span><span class="p">(</span><span class="n">transformationBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="w">    </span><span class="n">MTL</span><span class="o">::</span><span class="n">PrimitiveType</span><span class="w"> </span><span class="n">typeTriangle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTL</span><span class="o">::</span><span class="n">PrimitiveTypeTriangle</span><span class="p">;</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="w">    </span><span class="n">NS</span><span class="o">::</span><span class="n">UInteger</span><span class="w"> </span><span class="n">vertexStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="w">    </span><span class="n">NS</span><span class="o">::</span><span class="n">UInteger</span><span class="w"> </span><span class="n">vertexCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">36</span><span class="p">;</span>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setFragmentTexture</span><span class="p">(</span><span class="n">grassTexture</span><span class="o">-&gt;</span><span class="n">texture</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">drawPrimitives</span><span class="p">(</span><span class="n">typeTriangle</span><span class="p">,</span><span class="w"> </span><span class="n">vertexStart</span><span class="p">,</span><span class="w"> </span><span class="n">vertexCount</span><span class="p">);</span>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="p">}</span>
</code></pre></div>
Finally, in our <code>encodeRenderCommand()</code> function, we are simply telling our <code>renderCommandEncoder</code> to set our Depth Stencil State that we created earlier, and voila, we should now have a 3D cube rendering with proper depth information taken into account and an image that has 4x MSAA applied.</p>
<p><img alt="cube-odst" src="/images/cube-odst.png" /></p>
<h3 id="discarding-unecessary-faces-and-fragments">Discarding Unecessary Faces and Fragments</h3>
<p>Even though we've implemented a depth buffer and MSAA into our renderer, we're still processing a lot of unecessary fragments. To demonstrate this, a look at the image below:</p>
<p><img alt="zBuffer-lineDraw" src="/images/zBuffer2.png" /></p>
<p>Remember how I said the rendering pipeline processes a fragment and <em>then</em> does does the depth test on it? When we render in wireframe mode, we can see that pretty clearly. We need to make sure we aren't processing all of those back faces and faces we can't see.</p>
<p><div class="highlight"><span class="filename">mtl_engine.mm</span><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MTLEngine::encodeRenderCommand</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">RenderCommandEncoder</span><span class="o">*</span><span class="w"> </span><span class="n">renderCommandEncoder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="p">...</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="hll"><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setFrontFacingWinding</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">WindingCounterClockwise</span><span class="p">);</span>
</span><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="hll"><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setCullMode</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">CullModeBack</span><span class="p">);</span>
</span><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setTriangleFillMode</span><span class="p">(</span><span class="n">MTL</span><span class="o">::</span><span class="n">TriangleFillModeLines</span><span class="p">);</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setRenderPipelineState</span><span class="p">(</span><span class="n">metalRenderPSO</span><span class="p">);</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="n">renderCommandEncoder</span><span class="o">-&gt;</span><span class="n">setDepthStencilState</span><span class="p">(</span><span class="n">depthStencilState</span><span class="p">);</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="p">...</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="p">}</span>
</code></pre></div>
This is where the winding order finally comes into play. Remember that topic I discussed way back in the beginning of the chapter, and how we specifically specified our cube vertices with a Counter Clockwise Winding order? Well, we can give that information to Metal by telling the <code>renderCommandEncoder</code> to set the front face winding to <code>MTL::WindingCounterClockwise</code>, and to set the cull mode to <code>MTL::CullModeBack</code> so we can skip rendering those interior faces on the cube. Also notice here that I've set the triangle fill mode to <code>MTL::TriangleFillModeLines</code> so we can see the object in "wire-frame" mode. You can set it to <code>MTL::TriangleFillModeFill</code> to render like normal, or just leave it out and it will set that by default. And voila, we have a beautifully rendered wire-frame view of our cube, discarding the faces we can't see :D</p>
<p><img alt="faceCulling" src="/images/face-culling.png" /></p>
<p>The code for this chapter is accessible on the <a href="https://github.com/wmarti/MetalTutorial/"><strong>GitHub repository</strong></a> under branch Lesson_2_1.</p>
<p><img alt="cube-odst" src="/images/cube-odst.png" /></p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This image references Figure 1 in Section 1.6 of the Metal Shading Language Specification <a href="https://developer.apple.com/metal/Metal-Shading-Language-Specification.pdf">1.6 Metal Coordinate Systems</a>.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>


  




  <h2 id="__comments">Comments</h2>
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
  data-repo="wmarti/MetalTutorial"
  data-repo-id="R_kgDOI3W6fQ"
  data-category="Announcements"
  data-category-id="DIC_kwDOI3W6fc4CUFgH"
  data-mapping="pathname"
  data-strict="1"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="preferred_color_scheme"
  data-lang="en"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>
  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.indexes", "toc.follow", "content.tooltips"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fac441b0.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>